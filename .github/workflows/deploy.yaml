# name: CI/CD Pipeline

# on:
#   push:
#     branches:
#       - main

# jobs:
#   build-and-deploy:
#     runs-on: ubuntu-latest

#     steps:
#       # 1. Checkout source code
#       - name: Checkout source code
#         uses: actions/checkout@v3

#       # 2. Set up Docker Buildx
#       - name: Set up Docker Buildx
#         uses: docker/setup-buildx-action@v2

#       # 3. Cache Docker layers
#       - name: Cache Docker layers
#         uses: actions/cache@v3
#         with:
#           path: /home/runner/.buildx-cache
#           key: ${{ runner.os }}-buildx-${{ github.sha }}
#           restore-keys: |
#             ${{ runner.os }}-buildx-

#       # 4. Login to DockerHub
#       - name: Login to DockerHub
#         uses: docker/login-action@v2
#         with:
#           username: ${{ secrets.DOCKERHUB_USERNAME }}
#           password: ${{ secrets.DOCKERHUB_TOKEN }}

#       # 5. Build and push Docker image
#       - name: Build and push Docker image
#         uses: docker/build-push-action@v4
#         with:
#           context: .
#           push: true
#           tags: |
#             ${{ secrets.DOCKERHUB_USERNAME }}/sigongbot-server:latest
#             ${{ secrets.DOCKERHUB_USERNAME }}/sigongbot-server:${{ github.sha }}
#           cache-from: type=local,src=/home/runner/.buildx-cache
#           cache-to: type=local,dest=/home/runner/.buildx-cache

#       # 6. Copy configuration files
#       - name: Copy configuration files
#         uses: appleboy/scp-action@master
#         with:
#           host: ${{ secrets.WAS_HOST }}
#           username: ${{ secrets.WAS_USERNAME }}
#           key: ${{ secrets.SSH_KEY }}
#           port: ${{ secrets.WAS_SSH_PORT }}
#           source: "nginx/conf.d/default.conf,docker-compose.prod.yaml"
#           target: "/root"
#           strip_components: 0
#           timeout: 120s
#           command_timeout: 30m

#       # 7. Deploy to remote server
#       - name: Deploy to remote server
#         uses: appleboy/ssh-action@v0.1.6
#         with:
#           host: ${{ secrets.WAS_HOST }}
#           username: ${{ secrets.WAS_USERNAME }}
#           key: ${{ secrets.SSH_KEY }}
#           port: ${{ secrets.WAS_SSH_PORT }}
#           script: |
#             # Docker ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
#             if ! command -v docker &> /dev/null; then
#                 echo "Docker ì„¤ì¹˜ ì¤‘..."
#                 sudo apt update
#                 sudo apt install -y docker.io
#             fi

#             # Docker Compose ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
#             if ! command -v docker-compose &> /dev/null; then
#                 echo "Docker Compose ì„¤ì¹˜ ì¤‘..."
#                 sudo apt update
#                 sudo apt install -y docker-compose
#             fi

#             # Certbot ì„¤ì¹˜ í™•ì¸ ë° ì„¤ì¹˜
#             if ! command -v certbot &> /dev/null; then
#                 echo "Certbot ì„¤ì¹˜ ì¤‘..."
#                 sudo apt update
#                 sudo apt install -y certbot
#             fi

#             # SSL ì¸ì¦ì„œ ìƒíƒœ í™•ì¸ ë° ê°±ì‹ 
#             echo "SSL ì¸ì¦ì„œ ìƒíƒœ í™•ì¸ ì¤‘..."
#             if sudo certbot certificates | grep "INVALID: EXPIRED"; then
#                 echo "ë§Œë£Œëœ ì¸ì¦ì„œ ë°œê²¬. ê°±ì‹  ì‹œë„ ì¤‘..."
#                 docker-compose -f /root/docker-compose.prod.yaml stop nginx
#                 sudo certbot renew --force-renewal
#                 docker-compose -f /root/docker-compose.prod.yaml up -d nginx
#             fi

#             # SSL ì¸ì¦ì„œ ìžë™ ê°±ì‹  ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
#             cat > /root/renew-cert.sh << 'EOL'
#             #!/bin/bash
#             certbot renew --quiet
#             if [ $? -eq 0 ]; then
#                 docker-compose -f /root/docker-compose.prod.yaml exec -T nginx nginx -s reload
#                 echo "$(date): ì¸ì¦ì„œ ê°±ì‹  ì„±ê³µ" >> /var/log/certbot-renew.log
#             else
#                 echo "$(date): ì¸ì¦ì„œ ê°±ì‹  ì‹¤íŒ¨" >> /var/log/certbot-renew.log
#             fi
#             EOL

#             # ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬
#             chmod +x /root/renew-cert.sh

#             # ìžë™ ê°±ì‹  í¬ë¡  ìž‘ì—… ì„¤ì • (ê¸°ì¡´ ìž‘ì—… ì œê±° í›„ ìž¬ì„¤ì •)
#             (crontab -l 2>/dev/null | grep -v "renew-cert.sh" ; echo "0 0,12 * * * /root/renew-cert.sh") | crontab -

#             # ìž‘ì—… ë””ë ‰í† ë¦¬ë¡œ ì´ë™
#             cd /root
            
#             # SSL ì¸ì¦ì„œ ë””ë ‰í† ë¦¬ ê¶Œí•œ ì„¤ì •
#             sudo chown -R root:root /etc/letsencrypt
#             sudo find /etc/letsencrypt/archive -type f -exec chmod 644 {} \;
#             sudo find /etc/letsencrypt/live -type l -exec chmod 644 {} \;
#             sudo chmod 755 /etc/letsencrypt/live
#             sudo chmod 755 /etc/letsencrypt/archive
            
#             echo "ë¬´ì¤‘ë‹¨ ë°°í¬ ì‹œìž‘..."
            
#             # í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìƒì„±
#             cat > .env << EOL
#             SLACK_BOT_TOKEN=${{ secrets.SLACK_BOT_TOKEN }}
#             SLACK_APP_TOKEN=${{ secrets.SLACK_APP_TOKEN }}
#             SUPABASE_URL=${{ secrets.SUPABASE_URL }}
#             SUPABASE_KEY=${{ secrets.SUPABASE_KEY }}
#             DOCKERHUB_USERNAME=${{ secrets.DOCKERHUB_USERNAME }}
#             EOL
            
#             # í˜„ìž¬ í™œì„±í™”ëœ ì„œë²„ í™•ì¸ (docker-compose ì‚¬ìš©)
#             CURRENT=$(docker-compose -f docker-compose.prod.yaml ps | grep -o "blue\|green" | head -n 1)
            
#             if [ "$CURRENT" = "blue" ]; then
#               # Blueê°€ í™œì„±í™”ë˜ì–´ ìžˆìœ¼ë©´ Greenìœ¼ë¡œ ë°°í¬
#               export GREEN_VERSION=${{ github.sha }}
#               docker-compose -f docker-compose.prod.yaml up -d nginx green
              
#               sleep 10
              
#               sed -i 's/server blue:8000/server green:8000/' nginx/conf.d/default.conf
#               docker-compose -f docker-compose.prod.yaml exec -T nginx nginx -s reload
              
#               docker-compose -f docker-compose.prod.yaml stop blue
#             else
#               # Greenì´ í™œì„±í™”ë˜ì–´ ìžˆìœ¼ë©´ Blueë¡œ ë°°í¬
#               export BLUE_VERSION=${{ github.sha }}
#               docker-compose -f docker-compose.prod.yaml up -d nginx blue
              
#               sleep 10
              
#               sed -i 's/server green:8000/server blue:8000/' nginx/conf.d/default.conf
#               docker-compose -f docker-compose.prod.yaml exec -T nginx nginx -s reload
              
#               docker-compose -f docker-compose.prod.yaml stop green
#             fi

#             # ì´ë¯¸ì§€ ì •ë¦¬ (ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ì´ë¯¸ì§€, ì»¨í…Œì´ë„ˆ, ë„¤íŠ¸ì›Œí¬ë§Œ ì •ë¦¬)
#             docker system prune -af

#       # 8. Send a message to Slack
#       # TODO: channel í™˜ê²½ë³€ìˆ˜ë¡œ ë³€ê²½ í•„ìš”
#       - name: Send message to Slack
#         run: |
#           curl -H "Content-Type: application/json" \
#             -H "Authorization: Bearer ${{ secrets.SLACK_BOT_TOKEN }}" \
#             -d '{"channel": "C08QJQAPV54", "text": "ðŸŽ‰ Sigongbot ì„œë²„ ë°°í¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ðŸ˜‰"}' \
#             https://slack.com/api/chat.postMessage

